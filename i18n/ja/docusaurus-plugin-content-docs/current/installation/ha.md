---
title: 外部DBでの高可用
weight: 30
---

> **注:** Kubernetes クラスターに Rancher をインストールするための公式サポートは、v1.0.0 リリースで導入されました。

このセクションでは、外部データベースを使用して高可用性 K3s クラスターをインストールする方法について説明します。

単一サーバー クラスターはさまざまなユース ケースに対応できますが、Kubernetes コントロール プレーンのアップタイムが重要な環境では、HA 構成で K3 を実行できます。 HA K3s クラスターは以下で構成されます。

* Kubernetes API を提供し、他のコントロール プレーン サービスを実行する 2 つ以上の **サーバー ノード**
* アプリとサービスを実行するように指定された 0 個以上の **エージェント ノード**
* **外部データストア** (単一サーバーのセットアップで使用される組み込み SQLite データストアとは対照的に)
* サーバー ノードの前に配置され、エージェント ノードがクラスターに登録できるようにする **固定登録アドレス**

これらのコンポーネントがどのように連携するかについての詳細は、[アーキテクチャのセクション](../architecture/architecture.md#high-availability-k3s-server-with-an-external-db)を参照してください。

エージェントは固定登録アドレスを介して登録しますが、登録後、サーバー ノードの 1 つに直接接続を確立します。 これは、「k3s エージェント」プロセスによって開始される Websocket 接続であり、エージェント プロセスの一部として実行されるクライアント側のロード バランサーによって維持されます。

## インストールの概要

HA クラスターをセットアップするには、次の手順が必要です。

### 1. 外部データストアを作成する
最初に、クラスター用の外部データストアを作成する必要があります。 詳細については、[クラスター データストア オプション](datastore.md) のドキュメントを参照してください。

### 2.サーバーノードを起動する
K3s は、この HA 構成のために 2 つ以上のサーバー ノードを必要とします。 マシンの最小要件については、[要件](requirements.md) ガイドを参照してください。

これらのノードで「k3s server」コマンドを実行する場合、「datastore-endpoint」パラメータを設定して、K3s が外部データストアへの接続方法を認識できるようにする必要があります。 `token` パラメータを使用して、ノードを追加するときに決定論的トークンを設定することもできます。 空の場合、このトークンは後で使用するために自動的に生成されます。

たとえば、次のようなコマンドを使用して、外部データストアとして MySQL データベースを使用して K3s サーバーをインストールし、[トークンを設定](../reference/server-config.md#cluster-options) することができます。
```bash
curl -sfL https://get.k3s.io | sh -s - server \
  --token=SECRET \
  --datastore-endpoint="mysql://username:password@tcp(hostname:3306)/database-name"
```

データストア エンドポイントの形式は、データベースの種類によって異なります。 詳細については、[データストア エンドポイントの形式] (datastore.md#datastore-endpoint-format-and-functionality) のセクションを参照してください。

サーバー ノードの起動時に TLS 証明書を構成するには、[データストア構成ガイド](datastore.md#external-datastore-configuration-parameters) を参照してください。
:::note
単一サーバーのインストールで使用できるのと同じインストール オプションが、高可用性のインストールでも使用できます。 詳細については、[構成オプション](configuration.md) のドキュメントを参照してください。
:::

デフォルトでは、サーバー ノードはスケジュール可能であるため、ワークロードをそれらで起動できます。 ユーザー ワークロードが実行されない専用のコントロール プレーンが必要な場合は、テイントを使用できます。 `node-taint` パラメータを使用すると、`--node-taint CriticalAddonsOnly=true:NoExecute` のようにテイントを使用してノードを構成できます。

すべてのサーバー ノードで「k3s サーバー」プロセスを起動したら、「k3s kubectl get nodes」でクラスターが適切に起動していることを確認します。 サーバー ノードが Ready 状態になっているはずです。

### 3.固定登録アドレスを設定する

エージェント ノードには、登録先の URL が必要です。 これは任意のサーバー ノードの IP またはホスト名にすることができますが、多くの場合、それらは時間の経過とともに変化する可能性があります。 たとえば、グループのスケーリングをサポートするクラウドでクラスターを実行している場合、時間の経過とともにサーバー ノード グループをスケールアップおよびスケールダウンして、ノードが作成および破棄され、サーバー ノードの初期セットとは異なる IP を持つ可能性があります。 したがって、時間の経過とともに変化しない安定したエンドポイントがサーバー ノードの前にある必要があります。 このエンドポイントは、次のようなさまざまなアプローチを使用して設定できます。

* レイヤー 4 (TCP) ロード バランサー
* ラウンドロビン DNS
* 仮想またはエラスティック IP アドレス

このエンドポイントは、Kubernetes API へのアクセスにも使用できます。 たとえば、[kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/) ファイルを変更して、特定のノードではなくそのノードを指すようにすることができます。 このような構成で証明書エラーを回避するには、`--tls-san YOUR_IP_OR_HOSTNAME_HERE` オプションを使用してサーバーをインストールする必要があります。 このオプションは、追加のホスト名または IP を TLS 証明書のサブジェクト代替名として追加します。IP とホスト名の両方を介してアクセスする場合は、複数回指定できます。

### 4. オプション: 追加のサーバー ノードに参加する

ステップ 2 と同じコマンド例を使用して、最初のノードからのトークンを使用する必要がある追加のサーバー ノードに参加できます。

`--token` CLI フラグまたは `K3S_TOKEN` 変数なしで最初のサーバー ノードが起動された場合、トークン値は、既にクラスターに参加している任意のサーバーから取得できます。
```bash
cat /var/lib/rancher/k3s/server/token
```

[トークンを使用して](../reference/server-config.md#cluster-options):
```bash
curl -sfL https://get.k3s.io | sh -s - server \
  --token=SECRET \
  --datastore-endpoint="mysql://username:password@tcp(hostname:3306)/database-name"
```

すべてのサーバー ノードで同じでなければならない構成フラグがいくつかあります。
* ネットワーク関連のフラグ: `--cluster-dns`、`--cluster-domain`、`--cluster-cidr`、`--service-cidr`
* 特定のコンポーネントの展開を制御するフラグ: `--disable-helm-controller`、`--disable-kube-proxy`、`--disable-network-policy`、および `--disable` に渡されるすべてのコンポーネント
* 機能関連フラグ: `--secrets-encryption`
:::note
バックアップから復元してノードを追加するときに必要になるため、このトークンのコピーを必ず保持してください。 以前は、K3s は、外部 SQL データストアを使用するときにトークンの使用を強制しませんでした。
:::

### 5. オプション: エージェント ノードに参加する

K3s サーバー ノードはデフォルトでスケジュール可能であるため、HA K3s サーバー クラスタのノードの最小数は、2 つのサーバー ノードとゼロ エージェント ノードです。 アプリとサービスを実行するように指定されたノードを追加するには、エージェント ノードをクラスターに参加させます。

HA クラスター内のエージェント ノードに参加することは、単一サーバー クラスター内のエージェント ノードに参加することと同じです。 エージェントが登録する URL と使用するトークンを指定するだけです。
```bash
K3S_TOKEN=SECRET k3s agent --server https://fixed-registration-address:6443
```

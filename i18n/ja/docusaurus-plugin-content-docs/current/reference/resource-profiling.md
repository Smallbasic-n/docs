---
title: K3s リソースプロファイリング
shortTitle: リソースプロファイリング
weight: 1
---

このセクションでは、K3 の最小リソース要件を決定するためのテストの結果をキャプチャします。

結果は次のように要約されます。

| | コンポーネント | プロセッサ | 最小 CPU | Kine/SQLite での最小 RAM | etcd が組み込まれた最小 RAM |
|------------|-----|----------|--------------------- ------|--------------------------|
| | ワークロードのある K3s サーバー | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz | コアの 10% | 768 メートル | 896 メートル |
| | 単一エージェントの K3s クラスター | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz | コアの 10% | 512M | 768 メートル |
| | K3s エージェント | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz | コアの 5% | 256 メートル | 256 メートル |
| | ワークロードのある K3s サーバー | Pi4B BCM2711、1.50GHz | コアの 20% | 768 メートル | 896 メートル |
| | 単一エージェントの K3s クラスター | Pi4B BCM2711、1.50GHz | コアの 20% | 512M | 768 メートル |
| | K3s エージェント | Pi4B BCM2711、1.50GHz | コアの 10% | 256 メートル | 256 メートル |

- [リソース テストの範囲](#リソース テストの範囲)
- [ベースライン測定に含まれるコンポーネント](#components-included-for-baseline-measurements)
- [方法論](#methodology)
- [環境](#環境)
- [ベースライン リソース要件](#baseline-resource-requirements)
   - [ワークロードのある K3s サーバー](#k3s-server-with-a-workload)
   - [単一エージェントの K3s クラスター](#k3s-cluster-with-a-single-agent)
   - [K3s エージェント](#k3s-agent)
- [分析](#分析)
   - [主要なリソース使用率のドライバー](#primary-resource-utilization-drivers)
   - [エージェントとワークロードがクラスタ データストアに干渉しないようにする](#エージェントとワークロードがクラスタ データストアに干渉するのを防ぐ)

## リソーステストの範囲

リソース テストは、次の問題ステートメントに対処することを目的としていました。

- 単一ノードのクラスターで、実際のワークロードがクラスターにデプロイされると仮定して、K3s スタック サーバー スタック全体を実行するために確保する必要がある CPU、メモリ、および IOP の正当な最小量を決定します。
- エージェント (ワーカー) ノードで、Kubernetes および K3s コントロール プレーン コンポーネント (kubelet および k3s エージェント) 用に確保する必要がある CPU、メモリ、および IOP の正当な最小量を決定します。

## ベースライン測定に含まれるコンポーネント

テスト済みのコンポーネントは次のとおりです。

* パッケージ化されたすべてのコンポーネントが有効になっている K3s 1.19.2
* Prometheus + Grafana モニタリング スタック
* Kubernetes サンプル PHP ゲストブック アプリ

これらは、K3s パッケージ コンポーネント (Traefik Ingress、Klipper lb、ローカル パス ストレージ) のみを使用し、標準の監視スタック (Prometheus および Grafana) と Guestbook サンプル アプリを実行する安定したシステムの基準値です。

IOPS を含むリソースの数値は、Kubernetes データストアとコントロール プレーンのみを対象としており、システム レベルの管理エージェントやロギング、コンテナー イメージ管理、またはワークロード固有の要件のオーバーヘッドは含まれていません。
## 方法論

Prometheus v2.21.0 のスタンドアロン インスタンスを使用して、apt 経由でインストールされた「prometheus-node-exporter」を使用して、ホストの CPU、メモリ、およびディスク IO 統計を収集しました。

「systemd-cgtop」を使用して、systemd cgroup レベルの CPU とメモリ使用率をスポット チェックしました。 「system.slice/k3s.service」は、K3s と containerd の両方のリソース使用率を追跡しますが、個々のポッドは「kubepods」階層の下にあります。

サーバーおよびエージェント プロセスに統合された kubelet エクスポーターを使用して、「process_resident_memory_bytes」および「go_memstats_alloc_bytes」メトリックから追加の詳細な K3s メモリ使用率データが収集されました。

使用率の数値は、説明されているワークロードを実行しているノードでの定常状態の動作からの 95 パーセンタイルの読み取り値に基づいています。

＃＃ 環境

OS: Ubuntu 20.04 x86_64、aarch64

ハードウェア:

- AWS c5d.xlarge - 4 コア、8 GB RAM、NVME SSD
- Raspberry Pi 4 Model B - 4 コア、8 GB RAM、クラス 10 SDHC

## ベースラインのリソース要件

このセクションでは、K3s エージェント、ワークロードを持つ K3s サーバー、および 1 つのエージェントを持つ K3s サーバーの最小リソース要件を決定するためのテストの結果をキャプチャします。

### ワークロードのある K3s サーバー

これらは、K3s サーバーがワークロードとリソースを共有する単一ノード クラスターの要件です。

CPU 要件は次のとおりです。

| | リソース要件 | テスト済みプロセッサー |
|-----------|-----------------|
| | コアの 10% | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz |
| | コアの 20% | Pi4B BCM2711、1.50 GHz などの低電力プロセッサ |

IOPS とメモリの要件は次のとおりです。

| | テスト済みデータストア | IOPS | KiB/秒 | レイテンシ | ラム |
|-----------|------|---------|---------|--------|
| | カイン/SQLite | 10 | 500 | < 10 ミリ秒 | 768 メートル |
| | 埋め込み etcd | 50 | 250 | < 5 ミリ秒 | 896 メートル |

### 単一のエージェントを持つ K3s クラスター

これらは、K3s サーバー ノードと K3s エージェントを備えた K3s クラスターのベースライン要件ですが、ワークロードはありません。

CPU 要件は次のとおりです。

| | リソース要件 | テスト済みプロセッサー |
|-----------|-----------------|
| | コアの 10% | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz |
| | コアの 20% | Pi4B BCM2711、1.50GHz |

IOPS とメモリの要件は次のとおりです。

| | データストア | IOPS | KiB/秒 | レイテンシ | ラム |
|-----------|------|---------|---------|--------|
| | カイン/SQLite | 10 | 500 | < 10 ミリ秒 | 512M |
| | 埋め込み etcd | 50 | 250 | < 5 ミリ秒 | 768 メートル |

### K3s エージェント

CPU 要件は次のとおりです。

  リソース要件 | テスト済みプロセッサー |
|-----------|-----------------|
| | コアの 5% | Intel(R) Xeon(R) Platinum 8124M CPU、3.00 GHz |
| | コアの 10% | Pi4B BCM2711、1.50GHz |

256M の RAM が必要です。

＃＃ 分析

このセクションでは、K3s サーバーとエージェントの使用率に最も大きな影響を与えるものと、クラスター データストアをエージェントやワークロードからの干渉から保護する方法について説明します。

### リソース使用率の主な要因

K3s サーバーの使用率は、主に Kubernetes データストア (kine または etcd)、API サーバー、コントローラー マネージャー、およびスケジューラー制御ループのサポートと、システムの状態を変更するために必要な管理タスクによって決まります。 リソースの作成/変更/削除など、Kubernetes コントロール プレーンに追加の負荷をかける操作は、使用率に一時的なスパイクを引き起こします。 Kubernetes データストアを広範囲に使用するオペレーターまたはアプリ (Rancher や他のオペレーター タイプのアプリケーションなど) を使用すると、サーバーのリソース要件が増加します。 ノードを追加するか、多くのクラスター リソースを作成してクラスターをスケールアップすると、サーバーのリソース要件が増加します。

K3s エージェントの使用率は、主にコンテナ ライフサイクル管理制御ループのサポートによってもたらされます。 イメージの管理、ストレージのプロビジョニング、またはコンテナーの作成/破棄を伴う操作は、使用率に一時的なスパイクを引き起こします。 特にイメージのプルは、イメージ コンテンツをディスクに解凍する必要があるため、通常、CPU と IO に大きく依存します。 可能であれば、リソースの競合がないように、ワークロード ストレージ (ポッドの一時ストレージとボリューム) をエージェント コンポーネント (/var/lib/rancher/k3s/agent) から分離する必要があります。

### エージェントとワークロードがクラスタ データストアに干渉しないようにする

サーバーがワークロード ポッドもホストしている環境で実行している場合は、エージェントとワークロードの IOPS がデータストアに干渉しないように注意する必要があります。

これは、サーバー コンポーネント (/var/lib/rancher/k3s/server) をエージェント コンポーネント (/var/lib/rancher/k3s/agent) とは別のストレージ メディアに配置することで実現できます。これには、containerd イメージ ストアが含まれます。 .

ワークロード ストレージ (ポッドのエフェメラル ストレージとボリューム) も、データストアから分離する必要があります。

データストアのスループットとレイテンシの要件を満たさないと、コントロール プレーンからの応答が遅れたり、コントロール プレーンがシステム状態を維持できなくなったりする可能性があります。